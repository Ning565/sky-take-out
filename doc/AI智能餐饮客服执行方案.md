# AIæ™ºèƒ½é¤é¥®å®¢æœæ‰§è¡Œæ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡

åœ¨ç°æœ‰star-food-chainé¤é¥®ç³»ç»ŸåŸºç¡€ä¸Šï¼Œå¢åŠ AIæ™ºèƒ½å®¢æœé—®ç­”åŠŸèƒ½ï¼Œå®ç°ï¼š

- ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€æè¿°ç”¨é¤éœ€æ±‚ï¼ˆäººæ•°ã€ç›®çš„ã€å£å‘³åå¥½ï¼‰
- AIç³»ç»Ÿç†è§£éœ€æ±‚å¹¶æ¨èåˆé€‚çš„èœå“ç»„åˆ
- æä¾›å‹å¥½çš„å¤šè½®å¯¹è¯ä½“éªŒ

### æ ¸å¿ƒä»·å€¼

- **æŠ€æœ¯å±•ç¤º**ï¼šå±•ç¤ºå¤šAgentåä½œã€RAGæ£€ç´¢ã€æ¨èç®—æ³•ç­‰AIæŠ€æœ¯èƒ½åŠ›
- **ç”¨æˆ·ä½“éªŒ**ï¼šæå‡ç‚¹é¤æ•ˆç‡ï¼Œå‡å°‘é€‰æ‹©å›°éš¾
- **æˆæœ¬ä¼˜åŒ–**ï¼šå‡å°‘äººå·¥å®¢æœæŠ•å…¥

### æŠ€æœ¯åŸåˆ™

- **ç®€çº¦å®ç”¨**ï¼šåŸºäºç°æœ‰æŠ€æœ¯æ ˆï¼Œé¿å…è¿‡åº¦å·¥ç¨‹åŒ–
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šAIåŠŸèƒ½ç‹¬ç«‹ï¼Œä¸å½±å“ç°æœ‰ä¸šåŠ¡
- **æ˜“äºç»´æŠ¤**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç†è§£å’Œæ‰©å±•

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·å‰ç«¯      â”‚â”€â”€â”€â†’â”‚  Spring Boot    â”‚â”€â”€â”€â†’â”‚   AIæœåŠ¡å±‚      â”‚
â”‚  (Web/Mobile)   â”‚    â”‚   Controller    â”‚    â”‚ (Agent System)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                         â”‚
                              â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQLæ•°æ®åº“   â”‚â†â”€â”€â”€â”‚  Service/Mapper â”‚    â”‚   å¤§æ¨¡å‹API     â”‚
â”‚ (èœå“ã€è®¢å•ç­‰)  â”‚    â”‚      å±‚         â”‚    â”‚ (OpenAI/é€šä¹‰)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆæ˜ç»†

**ğŸ§  å¤§æ¨¡å‹åº”ç”¨æ ¸å¿ƒ**

- **AIæ¡†æ¶**ï¼šSpring AI 1.0.0 + LangChain4jï¼ˆæ··åˆä½¿ç”¨ï¼‰
- **å¤§è¯­è¨€æ¨¡å‹**ï¼šOpenAI GPT-4/3.5-turboï¼ˆä¸»è¦ï¼‰+ é€šä¹‰åƒé—®ï¼ˆå¤‡ç”¨ï¼‰
- **æ¨¡å‹æ§åˆ¶åè®®**ï¼šMCP (Model Control Protocol) è‡ªç ”å®ç°
- **å‘é‡åŒ–æ¨¡å‹**ï¼šOpenAI text-embedding-ada-002
- **RAGæ¡†æ¶**ï¼šSpring AI RAG + è‡ªå®šä¹‰æ£€ç´¢å¢å¼º

**ğŸ—ï¸ åŸºç¡€æŠ€æœ¯æ ˆ**

- **åç«¯æ¡†æ¶**ï¼šSpring Boot 3.2
- **æ•°æ®åº“**ï¼šMySQL 8.0ï¼ˆç°æœ‰ï¼‰
- **ç¼“å­˜**ï¼šRedis 7.0ï¼ˆç°æœ‰ï¼‰+ å‘é‡ç¼“å­˜
- **æ„å»ºå·¥å…·**ï¼šMaven 3.8

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡æ‰©å±•

### æ–°å¢è¡¨ç»“æ„

#### 1. å¯¹è¯è®°å½•è¡¨ (ai_conversation)

```sql
CREATE TABLE ai_conversation (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å¯¹è¯ID',
    session_id VARCHAR(64) NOT NULL COMMENT 'ä¼šè¯ID',
    user_id BIGINT COMMENT 'ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰',
    user_message TEXT NOT NULL COMMENT 'ç”¨æˆ·æ¶ˆæ¯',
    ai_response TEXT NOT NULL COMMENT 'AIå›å¤',
    conversation_context JSON COMMENT 'å¯¹è¯ä¸Šä¸‹æ–‡',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_time (created_time)
) COMMENT 'AIå¯¹è¯è®°å½•è¡¨';
```

#### 2. èœå“æ ‡ç­¾è¡¨ (dish_tags)

```sql
CREATE TABLE dish_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ ‡ç­¾ID',
    dish_id BIGINT NOT NULL COMMENT 'èœå“ID',
    tag_name VARCHAR(50) NOT NULL COMMENT 'æ ‡ç­¾åç§°',
    tag_type VARCHAR(20) NOT NULL COMMENT 'æ ‡ç­¾ç±»å‹(taste/cuisine/feature)',
    weight DECIMAL(3,2) DEFAULT 1.00 COMMENT 'æƒé‡',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_dish_id (dish_id),
    INDEX idx_tag_name (tag_name),
    INDEX idx_tag_type (tag_type),
    FOREIGN KEY (dish_id) REFERENCES dish(id)
) COMMENT 'èœå“æ ‡ç­¾è¡¨';
```

#### 3. æ¨èè®°å½•è¡¨ (ai_recommendation_log)

```sql
CREATE TABLE ai_recommendation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ¨èID',
    session_id VARCHAR(64) NOT NULL COMMENT 'ä¼šè¯ID',
    user_requirements JSON NOT NULL COMMENT 'ç”¨æˆ·éœ€æ±‚',
    recommended_dishes JSON NOT NULL COMMENT 'æ¨èèœå“åˆ—è¡¨',
    recommendation_score DECIMAL(3,2) COMMENT 'æ¨èç½®ä¿¡åº¦',
    user_feedback TINYINT COMMENT 'ç”¨æˆ·åé¦ˆ(1:æ»¡æ„ 0:ä¸æ»¡æ„)',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_session_id (session_id),
    INDEX idx_created_time (created_time)
) COMMENT 'AIæ¨èè®°å½•è¡¨';
```

### ç°æœ‰è¡¨ç»“æ„æ‰©å±•

#### èœå“è¡¨(dish)å­—æ®µæ‰©å±•

```sql
ALTER TABLE dish ADD COLUMN description TEXT COMMENT 'èœå“è¯¦ç»†æè¿°';
ALTER TABLE dish ADD COLUMN nutrition_info JSON COMMENT 'è¥å…»ä¿¡æ¯';
ALTER TABLE dish ADD COLUMN difficulty_level TINYINT DEFAULT 1 COMMENT 'åˆ¶ä½œéš¾åº¦ç­‰çº§(1-5)';
ALTER TABLE dish ADD COLUMN recommend_count INT DEFAULT 0 COMMENT 'è¢«æ¨èæ¬¡æ•°';
```

---

## ğŸ¤– AIæ¨¡å—è¯¦ç»†è®¾è®¡

### 1. å¤§æ¨¡å‹åº”ç”¨æ¶æ„æ€»è§ˆ

#### 1.1 å¤§æ¨¡å‹åº”ç”¨å¼€å‘æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ å¤šAgentåä½œ â†’ RAGæ£€ç´¢å¢å¼º â†’ Function Callingï¼ˆToolè°ƒç”¨ï¼‰â†’ æ™ºèƒ½å›å¤
    â†“           â†“            â†“                â†“                â†“
  è‡ªç„¶è¯­è¨€   â†’ ç»“æ„åŒ–ç†è§£  â†’ çŸ¥è¯†å¢å¼º   â†’ æ™ºèƒ½ä¸šåŠ¡è‡ªåŠ¨åŒ–  â†’ ç»“æœç”Ÿæˆ
```

#### 1.2 Spring AIæ¡†æ¶é›†æˆç­–ç•¥

```java
@Configuration
@EnableSpringAI
public class LLMApplicationConfig {
    
    // 1. ChatClient - å¤§æ¨¡å‹å¯¹è¯å®¢æˆ·ç«¯
    @Bean
    public ChatClient chatClient(OpenAiChatModel chatModel) {
        return ChatClient.builder(chatModel)
            .defaultAdvisors(new SimpleLoggerAdvisor())
            .build();
    }
    
    // 2. EmbeddingClient - å‘é‡åŒ–å®¢æˆ·ç«¯
    @Bean
    public EmbeddingClient embeddingClient(OpenAiEmbeddingModel embeddingModel) {
        return EmbeddingClient.builder(embeddingModel).build();
    }
    
    // 3. VectorStore - å‘é‡å­˜å‚¨
    @Bean
    public VectorStore vectorStore(EmbeddingClient embeddingClient) {
        return new RedisVectorStore(embeddingClient);
    }
}
```

### 2. RAGæ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰

#### 2.1 RAGæ¶æ„è®¾è®¡

RAG (Retrieval-Augmented Generation) æ˜¯è®©å¤§æ¨¡å‹"å…ˆæŸ¥èµ„æ–™å†å›ç­”"çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

```
ç”¨æˆ·é—®é¢˜ â†’ å‘é‡åŒ– â†’ ç›¸ä¼¼åº¦æ£€ç´¢ â†’ ä¸Šä¸‹æ–‡å¢å¼º â†’ å¤§æ¨¡å‹ç”Ÿæˆ â†’ æ™ºèƒ½å›å¤
    â†“        â†“        â†“         â†“         â†“        â†“
  "å·èœæ¨è" â†’ embedding â†’ æŸ¥æ‰¾å·èœçŸ¥è¯† â†’ æ³¨å…¥èœå“ä¿¡æ¯ â†’ GPTç”Ÿæˆ â†’ "æ¨èéº»å©†è±†è…..."
```

#### 2.2 Spring AI RAGå®ç°

```java
@Service
@Slf4j
public class RAGService {
    
    @Autowired
    private ChatClient chatClient;
    
    @Autowired
    private VectorStore vectorStore;
    
    @Autowired
    private DishKnowledgeRepository dishRepository;
    
    /**
     * RAGæ ¸å¿ƒæ–¹æ³•ï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆ
     */
    public String ragGenerate(String userQuery, ConversationContext context) {
        // 1. å‘é‡åŒ–ç”¨æˆ·æŸ¥è¯¢
        List<Double> queryEmbedding = vectorStore.embed(userQuery);
        
        // 2. ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³èœå“çŸ¥è¯†
        List<Document> relevantDocs = vectorStore.similaritySearch(
            SearchRequest.query(userQuery)
                .withTopK(5)
                .withSimilarityThreshold(0.7)
        );
        
        // 3. æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡
        String enhancedContext = buildEnhancedContext(relevantDocs, context);
        
        // 4. å¤§æ¨¡å‹ç”Ÿæˆå›å¤
        String ragPrompt = buildRAGPrompt(userQuery, enhancedContext);
        
        return chatClient.call(ragPrompt);
    }
    
    private String buildEnhancedContext(List<Document> docs, ConversationContext context) {
        StringBuilder contextBuilder = new StringBuilder();
        contextBuilder.append("ã€èœå“çŸ¥è¯†åº“ã€‘\n");
        
        for (Document doc : docs) {
            DishKnowledge dish = doc.getMetadata().get("dish", DishKnowledge.class);
            contextBuilder.append(String.format(
                "èœå“ï¼š%sï¼Œä»·æ ¼ï¼š%.2fï¼Œå£å‘³ï¼š%sï¼Œèœç³»ï¼š%sï¼Œæè¿°ï¼š%s\n",
                dish.getName(), dish.getPrice(), 
                dish.getTasteTag(), dish.getCuisineType(), dish.getDescription()
            ));
        }
        
        // æ·»åŠ å¯¹è¯å†å²ä¸Šä¸‹æ–‡
        if (context.getCurrentRequirement() != null) {
            contextBuilder.append("\nã€ç”¨æˆ·åå¥½ã€‘\n");
            contextBuilder.append("äººæ•°ï¼š").append(context.getCurrentRequirement().getPeopleCount()).append("äºº\n");
            contextBuilder.append("å£å‘³åå¥½ï¼š").append(context.getCurrentRequirement().getTastePreferences()).append("\n");
        }
        
        return contextBuilder.toString();
    }
    
    private String buildRAGPrompt(String userQuery, String enhancedContext) {
        return String.format("""
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é¤é¥®æ¨èåŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹çŸ¥è¯†åº“ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚
            
            %s
            
            ç”¨æˆ·é—®é¢˜ï¼š%s
            
            è¦æ±‚ï¼š
            1. å¿…é¡»åŸºäºçŸ¥è¯†åº“ä¸­çš„çœŸå®èœå“ä¿¡æ¯è¿›è¡Œæ¨è
            2. ä¸è¦ç¼–é€ ä¸å­˜åœ¨çš„èœå“æˆ–ä»·æ ¼
            3. æ ¹æ®ç”¨æˆ·åå¥½è¿›è¡Œä¸ªæ€§åŒ–æ¨è
            4. å›å¤è¦è‡ªç„¶å‹å¥½ï¼ŒåŒ…å«æ¨èç†ç”±
            5. å¦‚æœçŸ¥è¯†åº“ä¸­æ²¡æœ‰åˆé€‚ä¿¡æ¯ï¼Œè¯šå®è¯´æ˜å¹¶å¼•å¯¼ç”¨æˆ·
            
            å›å¤ï¼š
            """, enhancedContext, userQuery);
    }
}
```

#### 2.3 çŸ¥è¯†åº“æ„å»ºä¸å‘é‡åŒ–

```java
@Service
public class KnowledgeVectorService {
    
    @Autowired
    private VectorStore vectorStore;
    
    @Autowired
    private EmbeddingClient embeddingClient;
    
    @Autowired
    private DishMapper dishMapper;
    
    /**
     * æ„å»ºèœå“çŸ¥è¯†å‘é‡åº“
     */
    @PostConstruct
    public void buildDishVectorDatabase() {
        log.info("å¼€å§‹æ„å»ºèœå“çŸ¥è¯†å‘é‡åº“...");
        
        // 1. è·å–æ‰€æœ‰èœå“æ•°æ®
        List<Dish> allDishes = dishMapper.selectAll();
        
        // 2. æ„å»ºæ–‡æ¡£å¹¶å‘é‡åŒ–
        List<Document> documents = new ArrayList<>();
        
        for (Dish dish : allDishes) {
            // æ„å»ºå¯Œæ–‡æœ¬æè¿°
            String richDescription = buildRichDescription(dish);
            
            // åˆ›å»ºæ–‡æ¡£
            Document document = new Document(richDescription);
            document.getMetadata().put("dishId", dish.getId());
            document.getMetadata().put("dishName", dish.getName());
            document.getMetadata().put("price", dish.getPrice());
            document.getMetadata().put("categoryId", dish.getCategoryId());
            
            documents.add(document);
        }
        
        // 3. æ‰¹é‡å‘é‡åŒ–å¹¶å­˜å‚¨
        vectorStore.add(documents);
        
        log.info("èœå“çŸ¥è¯†å‘é‡åº“æ„å»ºå®Œæˆï¼Œå…±å¤„ç†{}é“èœå“", allDishes.size());
    }
    
    private String buildRichDescription(Dish dish) {
        // è·å–èœå“æ ‡ç­¾
        List<DishTag> tags = dishTagMapper.selectByDishId(dish.getId());
        
        StringBuilder description = new StringBuilder();
        description.append("èœå“åç§°ï¼š").append(dish.getName()).append("\n");
        description.append("ä»·æ ¼ï¼š").append(dish.getPrice()).append("å…ƒ\n");
        description.append("æè¿°ï¼š").append(dish.getDescription()).append("\n");
        
        // æŒ‰ç±»å‹åˆ†ç»„æ ‡ç­¾
        Map<String, List<String>> tagsByType = tags.stream()
            .collect(Collectors.groupingBy(
                DishTag::getTagType,
                Collectors.mapping(DishTag::getTagName, Collectors.toList())
            ));
        
        if (tagsByType.containsKey("taste")) {
            description.append("å£å‘³ï¼š").append(String.join("ã€", tagsByType.get("taste"))).append("\n");
        }
        if (tagsByType.containsKey("cuisine")) {
            description.append("èœç³»ï¼š").append(String.join("ã€", tagsByType.get("cuisine"))).append("\n");
        }
        if (tagsByType.containsKey("feature")) {
            description.append("ç‰¹è‰²ï¼š").append(String.join("ã€", tagsByType.get("feature"))).append("\n");
        }
        
        return description.toString();
    }
}
```

### 3. å¤šAgentåä½œç³»ç»Ÿï¼ˆSpring AIé›†æˆï¼‰

#### 3.1 Agentæ¶æ„ä¸åä½œæœºåˆ¶

```java
/**
 * AgentåŸºç¡€æ¥å£ - åŸºäºSpring AIè®¾è®¡
 */
public interface AIAgent {
    
    /**
     * Agentå¤„ç†é€»è¾‘
     */
    AgentResponse process(AgentRequest request, AgentContext context);
    
    /**
     * Agentèƒ½åŠ›æè¿°ï¼ˆç”¨äºMCPåè®®ï¼‰
     */
    AgentCapability getCapability();
    
    /**
     * Agentä¼˜å…ˆçº§
     */
    int getPriority();
}

/**
 * Agentä¸Šä¸‹æ–‡ - åŒ…å«å¤§æ¨¡å‹è°ƒç”¨èƒ½åŠ›
 */
@Data
public class AgentContext {
    private String sessionId;
    private ConversationHistory history;
    private ChatClient chatClient;          // Spring AI ChatClient
    private VectorStore vectorStore;        // Spring AI VectorStore
    private Map<String, Object> sharedData; // Agenté—´å…±äº«æ•°æ®
}
```

#### 3.2 UnderstandingAgent (ç†è§£Agent) - å¤§æ¨¡å‹NLU

**èŒè´£**ï¼šä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œè‡ªç„¶è¯­è¨€ç†è§£å’Œéœ€æ±‚æå–

```java
@Component
@Slf4j
public class UnderstandingAgent implements AIAgent {
    
    @Autowired
    private ChatClient chatClient;
    
    @Override
    public AgentResponse process(AgentRequest request, AgentContext context) {
        String userMessage = request.getUserMessage();
        
        // 1. æ„å»ºç»“æ„åŒ–æå–Prompt
        String extractionPrompt = buildExtractionPrompt(userMessage, context);
        
        // 2. è°ƒç”¨å¤§æ¨¡å‹è¿›è¡Œç»“æ„åŒ–æå–
        String llmResponse = chatClient.call(extractionPrompt);
        
        // 3. è§£æå¤§æ¨¡å‹è¿”å›çš„JSONç»“æ„
        UserRequirement requirement = parseRequirement(llmResponse);
        
        // 4. éªŒè¯å’Œæ ‡å‡†åŒ–
        UserRequirement validatedRequirement = validateAndNormalize(requirement);
        
        // 5. æ›´æ–°å…±äº«ä¸Šä¸‹æ–‡
        context.getSharedData().put("userRequirement", validatedRequirement);
        
        return AgentResponse.success("éœ€æ±‚ç†è§£å®Œæˆ", validatedRequirement);
    }
    
    private String buildExtractionPrompt(String userMessage, AgentContext context) {
        // è·å–å†å²å¯¹è¯å¢å¼ºç†è§£
        String conversationHistory = context.getHistory().getRecentMessages(3);
        
        return String.format("""
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é¤é¥®éœ€æ±‚ç†è§£åŠ©æ‰‹ã€‚è¯·ä»ç”¨æˆ·æ¶ˆæ¯ä¸­æå–ç»“æ„åŒ–çš„ç”¨é¤éœ€æ±‚ä¿¡æ¯ã€‚
            
            å†å²å¯¹è¯ï¼š
            %s
            
            å½“å‰ç”¨æˆ·æ¶ˆæ¯ï¼š%s
            
            è¯·æå–ä»¥ä¸‹ä¿¡æ¯å¹¶ä»¥JSONæ ¼å¼è¿”å›ï¼š
            {
                "peopleCount": "ç”¨é¤äººæ•°ï¼ˆæ•´æ•°ï¼Œå¦‚æœæœªæ˜ç¡®è¯´æ˜åˆ™ä¸ºnullï¼‰",
                "diningPurpose": "ç”¨é¤ç›®çš„ï¼ˆèšé¤/å•†åŠ¡/çº¦ä¼š/å®¶åº­/å¿«é¤ç­‰ï¼‰",
                "tastePreferences": ["å£å‘³åå¥½æ•°ç»„ï¼ˆè¾£/ç”œ/æ¸…æ·¡/é‡å£/é…¸/éº»ç­‰ï¼‰"],
                "cuisineType": "èœç³»åå¥½ï¼ˆå·èœ/ç²¤èœ/æ¹˜èœ/é²èœ/è‹èœ/æµ™èœ/é—½èœ/å¾½èœ/ä¸œåŒ—èœ/è¥¿é¤ç­‰ï¼‰",
                "budgetRange": "é¢„ç®—èŒƒå›´ï¼ˆäººå‡é¢„ç®—ï¼Œæ•´æ•°ï¼Œå¦‚100è¡¨ç¤ºäººå‡100å…ƒï¼‰",
                "dietaryRestrictions": ["é¥®é£Ÿç¦å¿Œï¼ˆç´ é£Ÿ/ä¸åƒè¾£/ä¸åƒæµ·é²œ/ä¸åƒç‰›è‚‰ç­‰ï¼‰"],
                "mealTime": "ç”¨é¤æ—¶é—´ï¼ˆæ—©é¤/åˆé¤/æ™šé¤/å¤œå®µï¼‰",
                "specialNeeds": ["ç‰¹æ®Šéœ€æ±‚ï¼ˆèšé¤/å•†åŠ¡å®´è¯·/çº¦ä¼š/å­©å­ç”¨é¤ç­‰ï¼‰"]
            }
            
            æ³¨æ„ï¼š
            1. å¦‚æœæŸä¸ªä¿¡æ¯ç”¨æˆ·æ²¡æœ‰æåˆ°ï¼Œå¯¹åº”å­—æ®µè®¾ä¸ºnullæˆ–ç©ºæ•°ç»„
            2. å°½é‡æ¨ç†ç”¨æˆ·çš„éšå«éœ€æ±‚ï¼ˆå¦‚"ä¸¤ä¸ªäºº"æ¨æ–­ä¸ºçº¦ä¼šæˆ–æœ‹å‹èšé¤ï¼‰
            3. åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–è§£é‡Šæ–‡æœ¬
            
            JSONç»“æœï¼š
            """, conversationHistory, userMessage);
    }
    
    private UserRequirement parseRequirement(String llmResponse) {
        try {
            // æ¸…ç†LLMå“åº”ï¼Œæå–JSONéƒ¨åˆ†
            String jsonPart = extractJSON(llmResponse);
            
            // ä½¿ç”¨Jacksonè§£æ
            ObjectMapper mapper = new ObjectMapper();
            return mapper.readValue(jsonPart, UserRequirement.class);
        } catch (Exception e) {
            log.error("è§£æç”¨æˆ·éœ€æ±‚å¤±è´¥ï¼š{}", llmResponse, e);
            return createDefaultRequirement();
        }
    }
    
    @Override
    public AgentCapability getCapability() {
        return AgentCapability.builder()
            .name("UnderstandingAgent")
            .description("è‡ªç„¶è¯­è¨€ç†è§£å’Œéœ€æ±‚æå–")
            .inputType("è‡ªç„¶è¯­è¨€æ–‡æœ¬")
            .outputType("ç»“æ„åŒ–ç”¨æˆ·éœ€æ±‚")
            .build();
    }
}
```

#### 3.3 RecommendationAgent (æ¨èAgent) - RAGå¢å¼ºæ¨è

**èŒè´£**ï¼šåŸºäºRAGæ£€ç´¢å’Œå¤§æ¨¡å‹ç”Ÿæˆæ¨èç»“æœ

```java
@Component
@Slf4j
public class RecommendationAgent implements AIAgent {
    
    @Autowired
    private RAGService ragService;
    
    @Autowired
    private VectorStore vectorStore;
    
    @Autowired
    private ContentBasedFilter contentFilter;
    
    @Override
    public AgentResponse process(AgentRequest request, AgentContext context) {
        // 1. è·å–ç†è§£Agentçš„ç»“æœ
        UserRequirement requirement = (UserRequirement) context.getSharedData().get("userRequirement");
        
        if (requirement == null) {
            return AgentResponse.error("ç¼ºå°‘ç”¨æˆ·éœ€æ±‚ä¿¡æ¯");
        }
        
        // 2. æ„å»ºæœç´¢æŸ¥è¯¢
        String searchQuery = buildSearchQuery(requirement);
        
        // 3. RAGæ£€ç´¢ç›¸å…³èœå“
        List<Document> relevantDishes = vectorStore.similaritySearch(
            SearchRequest.query(searchQuery)
                .withTopK(10)
                .withSimilarityThreshold(0.6)
        );
        
        // 4. åŸºäºå†…å®¹è¿‡æ»¤å’Œæ’åº
        List<DishRecommendation> filteredRecommendations = contentFilter.filterAndRank(
            relevantDishes, requirement
        );
        
        // 5. ä½¿ç”¨å¤§æ¨¡å‹ä¼˜åŒ–æ¨èç†ç”±
        List<DishRecommendation> enhancedRecommendations = enhanceWithLLM(
            filteredRecommendations, requirement, context
        );
        
        // 6. æ„å»ºæœ€ç»ˆæ¨èç»“æœ
        RecommendationResult result = RecommendationResult.builder()
            .dishes(enhancedRecommendations)
            .totalPrice(calculateTotalPrice(enhancedRecommendations))
            .confidenceScore(calculateConfidence(enhancedRecommendations))
            .build();
        
        // 7. ä¿å­˜åˆ°å…±äº«ä¸Šä¸‹æ–‡
        context.getSharedData().put("recommendationResult", result);
        
        return AgentResponse.success("æ¨èç”Ÿæˆå®Œæˆ", result);
    }
    
    private String buildSearchQuery(UserRequirement requirement) {
        StringBuilder query = new StringBuilder();
        
        if (requirement.getCuisineType() != null) {
            query.append(requirement.getCuisineType()).append(" ");
        }
        
        if (requirement.getTastePreferences() != null && !requirement.getTastePreferences().isEmpty()) {
            query.append(String.join(" ", requirement.getTastePreferences())).append(" ");
        }
        
        if (requirement.getDiningPurpose() != null) {
            query.append(requirement.getDiningPurpose()).append(" ");
        }
        
        return query.toString().trim();
    }
    
    private List<DishRecommendation> enhanceWithLLM(
            List<DishRecommendation> recommendations, 
            UserRequirement requirement,
            AgentContext context) {
        
        for (DishRecommendation rec : recommendations) {
            // ä½¿ç”¨å¤§æ¨¡å‹ç”Ÿæˆä¸ªæ€§åŒ–æ¨èç†ç”±
            String reasonPrompt = String.format("""
                ä¸ºä»¥ä¸‹èœå“ç”Ÿæˆæ¨èç†ç”±ï¼š
                
                èœå“ï¼š%s
                ä»·æ ¼ï¼š%.2få…ƒ
                ç”¨æˆ·éœ€æ±‚ï¼š%däººç”¨é¤ï¼Œå–œæ¬¢%sï¼Œåå¥½%sèœç³»
                
                è¯·ç”Ÿæˆä¸€å¥ç®€æ´çš„æ¨èç†ç”±ï¼ˆ30å­—ä»¥å†…ï¼‰ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆæ¨èè¿™é“èœï¼š
                """, 
                rec.getDish().getName(),
                rec.getDish().getPrice(),
                requirement.getPeopleCount(),
                requirement.getTastePreferences(),
                requirement.getCuisineType()
            );
            
            String reason = context.getChatClient().call(reasonPrompt);
            rec.setReasonText(reason.trim());
        }
        
        return recommendations;
    }
}
```

#### 3.4 ResponseAgent (å›ç­”Agent) - å¤§æ¨¡å‹è‡ªç„¶è¯­è¨€ç”Ÿæˆ

**èŒè´£**ï¼šå°†æ¨èç»“æœè½¬åŒ–ä¸ºè‡ªç„¶å‹å¥½çš„å¯¹è¯å›å¤

```java
@Component
@Slf4j
public class ResponseAgent implements AIAgent {
    
    @Autowired
    private ChatClient chatClient;
    
    @Override
    public AgentResponse process(AgentRequest request, AgentContext context) {
        // 1. è·å–æ¨èç»“æœ
        RecommendationResult recommendation = (RecommendationResult) 
            context.getSharedData().get("recommendationResult");
        
        UserRequirement requirement = (UserRequirement) 
            context.getSharedData().get("userRequirement");
        
        if (recommendation == null || recommendation.getDishes().isEmpty()) {
            return generateNoResultsResponse(requirement, context);
        }
        
        // 2. æ„å»ºå›å¤ç”ŸæˆPrompt
        String responsePrompt = buildResponsePrompt(recommendation, requirement, context);
        
        // 3. è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆè‡ªç„¶è¯­è¨€å›å¤
        String naturalResponse = chatClient.call(responsePrompt);
        
        // 4. ç”Ÿæˆåç»­é—®é¢˜
        List<String> followUpQuestions = generateFollowUpQuestions(recommendation, requirement, context);
        
        // 5. æ„å»ºå®Œæ•´å›å¤
        ChatResponse response = ChatResponse.builder()
            .messageText(naturalResponse)
            .recommendations(recommendation.getDishes())
            .followUpQuestions(followUpQuestions)
            .sessionId(context.getSessionId())
            .conversationState(ConversationState.RECOMMENDATION)
            .build();
        
        return AgentResponse.success("å›å¤ç”Ÿæˆå®Œæˆ", response);
    }
    
    private String buildResponsePrompt(RecommendationResult recommendation, 
                                     UserRequirement requirement, 
                                     AgentContext context) {
        StringBuilder dishList = new StringBuilder();
        for (DishRecommendation dish : recommendation.getDishes()) {
            dishList.append(String.format("- %sï¼ˆ%.2få…ƒï¼‰ï¼š%s\n", 
                dish.getDish().getName(), 
                dish.getDish().getPrice(),
                dish.getReasonText()
            ));
        }
        
        return String.format("""
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šå‹å¥½çš„é¤å…æœåŠ¡å‘˜ã€‚è¯·ä¸ºå®¢äººä»‹ç»æ¨èçš„èœå“ã€‚
            
            å®¢äººéœ€æ±‚ï¼š%däººç”¨é¤ï¼Œå–œæ¬¢%så£å‘³ï¼Œåå¥½%sèœç³»
            
            æ¨èèœå“ï¼š
            %s
            
            æ€»ä»·ï¼š%.2få…ƒï¼ˆäººå‡%.2få…ƒï¼‰
            
            è¦æ±‚ï¼š
            1. è¯­æ°”è¦äº²åˆ‡è‡ªç„¶ï¼ŒåƒçœŸå®æœåŠ¡å‘˜ä¸€æ ·
            2. ç®€è¦ä»‹ç»æ¨èçš„èœå“ç‰¹è‰²
            3. è¯´æ˜ä¸ºä»€ä¹ˆé€‚åˆå®¢äººçš„éœ€æ±‚
            4. æåˆ°æ€»ä»·å’Œäººå‡ä»·æ ¼
            5. æ•´ä½“å›å¤æ§åˆ¶åœ¨100å­—ä»¥å†…
            6. ä¸è¦ä½¿ç”¨"æ¨èæŒ‡æ•°"ç­‰ç”Ÿç¡¬è¯æ±‡
            
            å›å¤ï¼š
            """, 
            requirement.getPeopleCount(),
            requirement.getTastePreferences(),
            requirement.getCuisineType(),
            dishList.toString(),
            recommendation.getTotalPrice(),
            recommendation.getTotalPrice().divide(BigDecimal.valueOf(requirement.getPeopleCount()), 2, RoundingMode.HALF_UP)
        );
    }
    
    private List<String> generateFollowUpQuestions(RecommendationResult recommendation,
                                                  UserRequirement requirement,
                                                  AgentContext context) {
        // åŸºäºæ¨èç»“æœå’Œç”¨æˆ·éœ€æ±‚ç”Ÿæˆåç»­é—®é¢˜
        List<String> questions = new ArrayList<>();
        
        if (requirement.getBudgetRange() == null) {
            questions.add("å¯¹ä»·æ ¼æœ‰ä»€ä¹ˆè¦æ±‚å—ï¼Ÿ");
        }
        
        if (recommendation.getDishes().stream().noneMatch(d -> 
            d.getDish().getCategory().getName().contains("æ±¤"))) {
            questions.add("éœ€è¦é…ä¸ªæ±¤å—ï¼Ÿ");
        }
        
        if (requirement.getDietaryRestrictions() == null || requirement.getDietaryRestrictions().isEmpty()) {
            questions.add("æœ‰ä»€ä¹ˆå¿Œå£çš„å—ï¼Ÿ");
        }
        
        questions.add("è¿™äº›èœå“æ‚¨è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ");
        
        return questions.subList(0, Math.min(3, questions.size()));
    }
}
```

### 4. Function Callingï¼ˆFCï¼Œå‡½æ•°/å·¥å…·è°ƒç”¨ï¼‰æ¨¡å—è®¾è®¡

#### 4.1 ä¸šåŠ¡åœºæ™¯ä¸‹çš„å…¸å‹Tool

- **èœè°±/è¥å…»åˆ†æToolï¼ˆRecipeNutritionToolï¼‰**ï¼šå¯¹æ¥å¤–éƒ¨èœè°±/è¥å…»åˆ†æAPIï¼Œæ ¹æ®ç”¨æˆ·éœ€æ±‚æŸ¥è¯¢èœå“ä¿¡æ¯ã€è¥å…»æˆåˆ†ã€åšæ³•ç­‰ã€‚

**ä¸¾ä¾‹ï¼š**
ç”¨æˆ·è¾“å…¥"æˆ‘ä»¬ä¸‰ä¸ªäººæƒ³åƒè¾£çš„å·èœï¼Œé¢„ç®—äººå‡50ï¼Œèƒ½ä¸èƒ½å¸®æˆ‘æ¨èèœå“å¹¶åˆ†æè¥å…»ï¼Ÿ"

- ç†è§£Agentæå–ç»“æ„åŒ–éœ€æ±‚
- Function Calling Agentè‡ªåŠ¨è°ƒç”¨RecipeNutritionTool.queryRecipeAndNutritionï¼Œè·å–èœå“æ¨èåŠè¥å…»åˆ†æ
- å›å¤Agentå‘ŠçŸ¥æ¨èç»“æœå’Œè¥å…»ä¿¡æ¯

#### 4.2 æŠ€æœ¯æ¶æ„ä¸æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ Agentç»“æ„åŒ–ç†è§£ â†’ å¤–éƒ¨èœè°±/è¥å…»åˆ†æAPI Toolï¼ˆFunction Callingï¼‰â†’ æ™ºèƒ½å›å¤
```

- å¤§æ¨¡å‹é€šè¿‡Function Callingèƒ½åŠ›ï¼Œè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œè°ƒç”¨å”¯ä¸€çš„RecipeNutritionTool
- Toolæ‰§è¡Œåå°†ç»“æœåé¦ˆç»™å¤§æ¨¡å‹ï¼Œç”±å›å¤Agentç”Ÿæˆæœ€ç»ˆå›å¤

## 4.3 Toolæ¥å£è®¾è®¡ç¤ºä¾‹

```java
// èœè°±/è¥å…»åˆ†æToolæ¥å£
public class RecipeNutritionTool {
    public RecipeNutritionResult queryRecipeAndNutrition(UserRequirement req) {
        // è°ƒç”¨å¤–éƒ¨APIï¼Œè¿”å›èœå“æ¨èåŠè¥å…»åˆ†æ
    }
}
```

#### 4.4 Function Callingåœ¨ä¸šåŠ¡ä¸­çš„ä»·å€¼

- **æ™ºèƒ½è‡ªåŠ¨åŒ–**ï¼šAIå¯æ ¹æ®ç”¨æˆ·æ„å›¾è‡ªåŠ¨æ¨èèœå“å¹¶åˆ†æè¥å…»ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚
- **ä¸šåŠ¡é—­ç¯**ï¼šAIä¸ä»…èƒ½æ¨èï¼Œè¿˜èƒ½ç›´æ¥æä¾›è¥å…»åˆ†æï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
- **å·¥ç¨‹ç®€æ´**ï¼šåªéœ€å¯¹æ¥ä¸€ä¸ªå¤–éƒ¨APIï¼Œå¼€å‘ç»´æŠ¤æˆæœ¬ä½ã€‚

#### 4.5 ä»£ç æµç¨‹ç¤ºä¾‹

```java
// åœ¨Agentæµç¨‹ä¸­é›†æˆFunction Calling
if (userIntent.contains("æ¨è") || userIntent.contains("è¥å…»")) {
    RecipeNutritionResult result = recipeNutritionTool.queryRecipeAndNutrition(requirement);
    // ç”ŸæˆAIå›å¤
    return "ä¸ºæ‚¨æ¨èèœå“ï¼š" + result.getRecipeList() + "ï¼Œè¥å…»åˆ†æï¼š" + result.getNutritionInfo();
}
```

---

## ğŸ”Œ æ¥å£è®¾è®¡è§„èŒƒ

### 1. REST APIè®¾è®¡

#### 1.1 èŠå¤©å¯¹è¯æ¥å£

```http
POST /api/ai/chat
Content-Type: application/json

{
    "sessionId": "session_12345",
    "message": "æˆ‘æƒ³è¦2ä¸ªäººåƒè¾£ä¸€ç‚¹çš„å·èœ",
    "userId": 10001
}
```

**å“åº”æ ¼å¼**ï¼š

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "sessionId": "session_12345",
        "response": "å¥½çš„ï¼ä¸º2ä½å®¢äººæ¨èå‡ é“ç»å…¸å·èœï¼šéº»å©†è±†è…ã€å®«ä¿é¸¡ä¸ã€æ°´ç…®é±¼ç‰‡ã€‚è¿™äº›èœå“å£æ„Ÿéº»è¾£ï¼Œå¾ˆé€‚åˆå–œæ¬¢è¾£å‘³çš„æœ‹å‹ã€‚",
        "recommendations": [
            {
                "dishId": 1001,
                "dishName": "éº»å©†è±†è…",
                "price": 28.00,
                "description": "ç»å…¸å·èœï¼Œè±†è…å«©æ»‘ï¼Œéº»è¾£é²œé¦™",
                "matchScore": 0.95,
                "reason": "ç¬¦åˆæ‚¨çš„è¾£å‘³åå¥½ï¼Œé€‚åˆ2äººä»½"
            }
        ],
        "followUpQuestions": [
            "éœ€è¦æ­é…ä¸€äº›æ¸…æ·¡çš„æ±¤å“å—ï¼Ÿ",
            "å¯¹é¢„ç®—æœ‰ä»€ä¹ˆè¦æ±‚å—ï¼Ÿ"
        ],
        "conversationState": "RECOMMENDATION"
    }
}
```

#### 1.2 è·å–å¯¹è¯å†å²

```http
GET /api/ai/conversation/{sessionId}
```

#### 1.3 æ¨èåé¦ˆæ¥å£

```http
POST /api/ai/feedback
{
    "sessionId": "session_12345",
    "recommendationId": 1001,
    "feedback": 1,
    "comment": "æ¨èå¾ˆå¥½ï¼Œå·²ä¸‹å•"
}
```

### 2. å†…éƒ¨æœåŠ¡æ¥å£

#### 2.1 Toolæ¥å£å®šä¹‰ï¼ˆFunction Callingï¼‰

```java
public interface Tool {
    String getName();
    Object call(Map<String, Object> params);
}

// å…·ä½“å®ç°
public class RecipeNutritionTool implements Tool {
    @Override
    public String getName() { return "RecipeNutritionTool"; }
    @Override
    public Object call(Map<String, Object> params) {
        // è°ƒç”¨å¤–éƒ¨APIï¼Œè¿”å›èœå“åŠè¥å…»åˆ†æ
    }
}
```

#### 2.2 Agentä¸Toolåä½œ

- Agentæ ¹æ®å¤§æ¨¡å‹è¾“å‡ºçš„å‡½æ•°è°ƒç”¨æ„å›¾ï¼Œè‡ªåŠ¨è°ƒç”¨å”¯ä¸€çš„RecipeNutritionTool
- Toolæ‰§è¡Œåå°†ç»“æœåé¦ˆç»™Agentï¼Œç”±å›å¤Agentç”Ÿæˆæœ€ç»ˆå›å¤

---

## ğŸ“ è¯¦ç»†å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ3-4å¤©ï¼‰

#### Day 1: å¤§æ¨¡å‹åº”ç”¨ç¯å¢ƒé…ç½®

1. **æ›´æ–°pom.xmlæ·»åŠ å¤§æ¨¡å‹åº”ç”¨ä¾èµ–**

```xml
<!-- Spring AIæ ¸å¿ƒä¾èµ– -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
    <version>1.0.0</version>
</dependency>
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-core</artifactId>
    <version>1.0.0</version>
</dependency>

<!-- å‘é‡å­˜å‚¨ä¾èµ– -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-redis-store</artifactId>
    <version>1.0.0</version>
</dependency>

<!-- LangChain4jé›†æˆï¼ˆå¯é€‰ï¼‰-->
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-spring-boot-starter</artifactId>
    <version>0.25.0</version>
</dependency>

<!-- JSONå¤„ç†å¢å¼º -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>

<!-- HTTPå®¢æˆ·ç«¯ï¼ˆMCPåè®®ï¼‰ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

2. **é…ç½®application.yml - å¤§æ¨¡å‹åº”ç”¨é…ç½®**

```yaml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY:your_api_key_here}
      base-url: ${OPENAI_BASE_URL:https://api.openai.com}
      chat:
        options:
          model: gpt-3.5-turbo
          temperature: 0.7
          max-tokens: 1000
          top-p: 1.0
      embedding:
        options:
          model: text-embedding-ada-002
    
    # é€šä¹‰åƒé—®é…ç½®ï¼ˆå¤‡ç”¨æ¨¡å‹ï¼‰
    dashscope:
      api-key: ${DASHSCOPE_API_KEY:your_dashscope_key}
      chat:
        options:
          model: qwen-turbo
          temperature: 0.7

# å¤§æ¨¡å‹åº”ç”¨ä¸“ç”¨é…ç½®
llm:
  # MCPåè®®é…ç½®
  mcp:
    server:
      port: 8081
      max-connections: 100
    client:
      timeout: 30s
      retry-count: 3
  
  # RAGé…ç½®
  rag:
    vector-store:
      type: redis
      similarity-threshold: 0.7
      max-results: 10
    embedding:
      batch-size: 10
      cache-ttl: 3600
  
  # Agentåä½œé…ç½®
  agents:
    understanding:
      model-preference: gpt-3.5-turbo
      timeout: 10s
    recommendation:
      model-preference: gpt-4
      timeout: 15s
    response:
      model-preference: gpt-3.5-turbo
      timeout: 8s

# AIå¯¹è¯é…ç½®
ai:
  conversation:
    session-timeout: 1800  # 30åˆ†é’Ÿ
    max-history-size: 20
  recommendation:
    max-dishes-count: 10
    default-match-threshold: 0.6
```

#### Day 2: æ•°æ®åº“å’Œå‘é‡å­˜å‚¨è®¾è®¡

1. **æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºAIç›¸å…³è¡¨**
2. **é…ç½®Rediså‘é‡å­˜å‚¨**

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    database: 1  # ä¸“é—¨ç”¨äºå‘é‡å­˜å‚¨
```

3. **ç¼–å†™MyBatis Mapperæ¥å£å’ŒXML**
4. **åˆ›å»ºAIç›¸å…³çš„Entityå’ŒDTOç±»**

#### Day 3-4: å¤§æ¨¡å‹åº”ç”¨æ¡†æ¶æ­å»º

1. **åˆ›å»ºå¤§æ¨¡å‹åº”ç”¨åŒ…ç»“æ„**

```
com.star.ai/
â”œâ”€â”€ llm/                           # å¤§æ¨¡å‹åº”ç”¨æ ¸å¿ƒ
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ LLMApplicationConfig.java      # Spring AIé…ç½®
â”‚   â”‚   â”œâ”€â”€ MCPConfiguration.java          # MCPåè®®é…ç½®
â”‚   â”‚   â””â”€â”€ VectorStoreConfig.java         # å‘é‡å­˜å‚¨é…ç½®
â”‚   â”œâ”€â”€ client/
â”‚   â”‚   â”œâ”€â”€ MCPClient.java                 # MCPå®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ ModelServiceManager.java      # æ¨¡å‹æœåŠ¡ç®¡ç†
â”‚   â””â”€â”€ server/
â”‚       â”œâ”€â”€ MCPServer.java                 # MCPæœåŠ¡å™¨
â”‚       â””â”€â”€ ModelController.java           # æ¨¡å‹æ§åˆ¶æ¥å£
â”œâ”€â”€ agent/                         # å¤šAgentç³»ç»Ÿ
â”‚   â”œâ”€â”€ AgentCoordinator.java              # Agentåè°ƒå™¨
â”‚   â”œâ”€â”€ UnderstandingAgent.java            # ç†è§£Agent
â”‚   â”œâ”€â”€ RecommendationAgent.java           # æ¨èAgent
â”‚   â”œâ”€â”€ ResponseAgent.java                 # å›ç­”Agent
â”‚   â””â”€â”€ base/
â”‚       â”œâ”€â”€ AIAgent.java                   # AgentåŸºç¡€æ¥å£
â”‚       â”œâ”€â”€ AgentContext.java              # Agentä¸Šä¸‹æ–‡
â”‚       â””â”€â”€ AgentCapability.java           # Agentèƒ½åŠ›æè¿°
â”œâ”€â”€ rag/                           # RAGæ£€ç´¢å¢å¼º
â”‚   â”œâ”€â”€ RAGService.java                    # RAGæ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ KnowledgeVectorService.java        # çŸ¥è¯†å‘é‡åŒ–
â”‚   â”œâ”€â”€ VectorSearchService.java           # å‘é‡æ£€ç´¢
â”‚   â””â”€â”€ DocumentProcessor.java             # æ–‡æ¡£å¤„ç†
â”œâ”€â”€ chat/                          # å¯¹è¯ç®¡ç†
â”‚   â”œâ”€â”€ ChatController.java                # å¯¹è¯æ¥å£
â”‚   â”œâ”€â”€ ConversationService.java           # å¯¹è¯æœåŠ¡
â”‚   â”œâ”€â”€ ConversationContext.java           # å¯¹è¯ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ MessageProcessor.java              # æ¶ˆæ¯å¤„ç†
â””â”€â”€ recommendation/                # æ™ºèƒ½æ¨è
    â”œâ”€â”€ RecommendationEngine.java          # æ¨èå¼•æ“
    â”œâ”€â”€ ContentBasedFilter.java            # åŸºäºå†…å®¹æ¨è
    â””â”€â”€ DishMatcher.java                   # èœå“åŒ¹é…
```

2. **å®ç°Spring AIé›†æˆçš„åŸºç¡€ç±»**

```java
@Configuration
@EnableSpringAI
public class LLMApplicationConfig {
    // ChatClient, EmbeddingClient, VectorStoreé…ç½®
}
```

### é˜¶æ®µäºŒï¼šå¤§æ¨¡å‹åº”ç”¨æ ¸å¿ƒå®ç°ï¼ˆ5-6å¤©ï¼‰

#### Day 5-6: RAGæ£€ç´¢å¢å¼ºç³»ç»Ÿå®ç°

1. **Spring AI RAGæ ¸å¿ƒæœåŠ¡**

```java
@Service
@Slf4j
public class RAGService {
    
    @Autowired
    private ChatClient chatClient;  // Spring AI ChatClient
    
    @Autowired
    private VectorStore vectorStore;  // Spring AI VectorStore
    
    /**
     * RAGæ ¸å¿ƒï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆ
     */
    public String ragGenerate(String userQuery, ConversationContext context) {
        // 1. å‘é‡åŒ–æŸ¥è¯¢
        List<Document> relevantDocs = vectorStore.similaritySearch(
            SearchRequest.query(userQuery)
                .withTopK(5)
                .withSimilarityThreshold(0.7)
        );
        
        // 2. æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡
        String enhancedContext = buildEnhancedContext(relevantDocs, context);
        
        // 3. å¤§æ¨¡å‹ç”Ÿæˆï¼ˆæ£€ç´¢å¢å¼ºï¼‰
        String ragPrompt = buildRAGPrompt(userQuery, enhancedContext);
        return chatClient.call(ragPrompt);
    }
}
```

2. **çŸ¥è¯†åº“å‘é‡åŒ–æ„å»º**

```java
@Service
public class KnowledgeVectorService {
    
    /**
     * æ„å»ºèœå“çŸ¥è¯†å‘é‡åº“
     */
    @PostConstruct
    public void buildDishVectorDatabase() {
        List<Dish> allDishes = dishMapper.selectAll();
        List<Document> documents = new ArrayList<>();
        
        for (Dish dish : allDishes) {
            String richDescription = buildRichDescription(dish);
            Document document = new Document(richDescription);
            // æ·»åŠ å…ƒæ•°æ®
            document.getMetadata().put("dishId", dish.getId());
            documents.add(document);
        }
        
        // æ‰¹é‡å‘é‡åŒ–å¹¶å­˜å‚¨åˆ°Redis
        vectorStore.add(documents);
    }
}
```

#### Day 7-8: å¤šAgentåä½œç³»ç»Ÿå®ç°

1. **å¤§æ¨¡å‹é©±åŠ¨çš„UnderstandingAgent**

```java
@Component
@Slf4j
public class UnderstandingAgent implements AIAgent {
    
    @Autowired
    private ChatClient chatClient;  // é€šè¿‡MCPè°ƒç”¨å¤§æ¨¡å‹
    
    @Override
    public AgentResponse process(AgentRequest request, AgentContext context) {
        // ä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œè‡ªç„¶è¯­è¨€ç†è§£
        String extractionPrompt = buildExtractionPrompt(request.getUserMessage(), context);
        String llmResponse = chatClient.call(extractionPrompt);
        
        // è§£æå¤§æ¨¡å‹è¿”å›çš„ç»“æ„åŒ–æ•°æ®
        UserRequirement requirement = parseRequirement(llmResponse);
        
        // ä¿å­˜åˆ°Agenté—´å…±äº«ä¸Šä¸‹æ–‡
        context.getSharedData().put("userRequirement", requirement);
        
        return AgentResponse.success("éœ€æ±‚ç†è§£å®Œæˆ", requirement);
    }
}
```

2. **RAGå¢å¼ºçš„RecommendationAgent**
3. **å¤§æ¨¡å‹ç”Ÿæˆçš„ResponseAgent**
4. **MCPé›†æˆçš„AgentCoordinator**

#### Day 9-10: Function Callingï¼ˆToolè°ƒç”¨ï¼‰é›†æˆ

1. **å®šä¹‰æ ‡å‡†Toolæ¥å£å’Œå¸¸ç”¨ä¸šåŠ¡Toolï¼ˆOrderToolã€CouponToolç­‰ï¼‰**
2. **åœ¨Agentæµç¨‹ä¸­é›†æˆFunction Callingèƒ½åŠ›**
3. **å¤§æ¨¡å‹è¾“å‡ºå‡½æ•°è°ƒç”¨æ„å›¾æ—¶ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”Toolå¹¶æ‰§è¡Œ**
4. **å°†Toolæ‰§è¡Œç»“æœåé¦ˆç»™å¤§æ¨¡å‹ï¼Œç”±å›å¤Agentç”Ÿæˆæœ€ç»ˆå›å¤**

### é˜¶æ®µä¸‰ï¼šå¤§æ¨¡å‹åº”ç”¨æ¥å£å±‚ï¼ˆ3-4å¤©ï¼‰

#### Day 11-12: å¤§æ¨¡å‹åº”ç”¨æ¥å£å®ç°

1. **AIèŠå¤©Controller - é›†æˆå¤šAgentå’ŒRAG**

```java
@RestController
@RequestMapping("/api/ai")
@Slf4j
public class ChatController {
    
    @Autowired
    private AgentCoordinator agentCoordinator;  // å¤šAgentåè°ƒå™¨
    
    @Autowired
    private ConversationService conversationService;
    
    @Autowired
    private MCPClient mcpClient;  // MCPåè®®å®¢æˆ·ç«¯
    
    /**
     * AIæ™ºèƒ½å¯¹è¯æ¥å£ - å¤§æ¨¡å‹åº”ç”¨æ ¸å¿ƒ
     */
    @PostMapping("/chat")
    public Result<ChatResponse> chat(@RequestBody ChatRequest request) {
        try {
            log.info("æ”¶åˆ°AIå¯¹è¯è¯·æ±‚: sessionId={}, message={}", 
                request.getSessionId(), request.getMessage());
            
            // é€šè¿‡å¤šAgentåä½œå¤„ç†ç”¨æˆ·æ¶ˆæ¯
            ChatResponse response = conversationService.processMessage(
                request.getSessionId(), 
                request.getMessage(), 
                request.getUserId()
            );
            
            log.info("AIå¯¹è¯å¤„ç†å®Œæˆ: sessionId={}, recommendations={}", 
                request.getSessionId(), response.getRecommendations().size());
            
            return Result.success(response);
        } catch (Exception e) {
            log.error("AIå¯¹è¯å¤„ç†å¤±è´¥", e);
            return Result.error("æ™ºèƒ½å®¢æœæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•");
        }
    }
    
    /**
     * RAGçŸ¥è¯†åº“æœç´¢æ¥å£
     */
    @PostMapping("/search")
    public Result<List<Document>> searchKnowledge(@RequestBody SearchRequest request) {
        try {
            List<Document> results = ragService.searchKnowledge(
                request.getQuery(), 
                request.getTopK(), 
                request.getThreshold()
            );
            return Result.success(results);
        } catch (Exception e) {
            log.error("çŸ¥è¯†åº“æœç´¢å¤±è´¥", e);
            return Result.error("çŸ¥è¯†åº“æœç´¢æš‚æ—¶ä¸å¯ç”¨");
        }
    }
    
    /**
     * å¤šæ¨¡å‹å¯¹æ¯”æ¥å£ï¼ˆå±•ç¤ºMCPèƒ½åŠ›ï¼‰
     */
    @PostMapping("/compare")
    public Result<Map<String, String>> compareModels(@RequestBody CompareRequest request) {
        try {
            Map<String, String> results = new HashMap<>();
            
            // å¹¶è¡Œè°ƒç”¨å¤šä¸ªæ¨¡å‹
            List<String> modelIds = Arrays.asList("gpt-4", "gpt-3.5-turbo", "qwen-turbo");
            
            MCPRequest mcpRequest = MCPRequest.builder()
                .type(RequestType.CHAT)
                .content(request.getPrompt())
                .build();
            
            for (String modelId : modelIds) {
                mcpRequest.setModelId(modelId);
                MCPResponse response = mcpClient.sendRequest(mcpRequest);
                results.put(modelId, response.getContent());
            }
            
            return Result.success(results);
        } catch (Exception e) {
            log.error("æ¨¡å‹å¯¹æ¯”å¤±è´¥", e);
            return Result.error("æ¨¡å‹å¯¹æ¯”æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        }
    }
}
```

2. **ConversationService - é›†æˆå¤§æ¨¡å‹åº”ç”¨èƒ½åŠ›**

```java
@Service
@Slf4j
public class ConversationServiceImpl implements ConversationService {
    
    @Autowired
    private AgentCoordinator agentCoordinator;  // å¤šAgentåè°ƒ
    
    @Autowired
    private RAGService ragService;  // RAGæ£€ç´¢å¢å¼º
    
    @Autowired
    private MCPClient mcpClient;  // MCPæ¨¡å‹è°ƒç”¨
    
    @Override
    public ChatResponse processMessage(String sessionId, String message, Long userId) {
        log.info("å¼€å§‹å¤„ç†å¤§æ¨¡å‹åº”ç”¨è¯·æ±‚: sessionId={}", sessionId);
        
        try {
            // 1. è·å–æˆ–åˆ›å»ºå¯¹è¯ä¸Šä¸‹æ–‡
            ConversationContext context = contextManager.getOrCreateContext(sessionId, userId);
            
            // 2. é€šè¿‡å¤šAgentåä½œå¤„ç†æ¶ˆæ¯ï¼ˆæ¯ä¸ªAgentéƒ½ä¼šè°ƒç”¨å¤§æ¨¡å‹ï¼‰
            ChatResponse response = agentCoordinator.process(message, context);
            
            // 3. ä¿å­˜å¯¹è¯è®°å½•ï¼ˆåŒ…å«å¤§æ¨¡å‹è°ƒç”¨ä¿¡æ¯ï¼‰
            saveConversationWithLLMInfo(sessionId, message, response);
            
            // 4. æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡
            contextManager.updateContext(context);
            
            log.info("å¤§æ¨¡å‹åº”ç”¨å¤„ç†å®Œæˆ: sessionId={}, agentCalls={}", 
                sessionId, response.getAgentCallCount());
            
            return response;
            
        } catch (Exception e) {
            log.error("å¤§æ¨¡å‹åº”ç”¨å¤„ç†å¼‚å¸¸: sessionId=" + sessionId, e);
            return createFallbackResponse(sessionId, "æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚");
        }
    }
    
    private void saveConversationWithLLMInfo(String sessionId, String message, ChatResponse response) {
        AiConversation conversation = new AiConversation();
        conversation.setSessionId(sessionId);
        conversation.setUserMessage(message);
        conversation.setAiResponse(response.getMessageText());
        
        // ä¿å­˜å¤§æ¨¡å‹è°ƒç”¨ä¿¡æ¯
        Map<String, Object> llmInfo = new HashMap<>();
        llmInfo.put("modelCalls", response.getModelCalls());
        llmInfo.put("totalTokens", response.getTotalTokens());
        llmInfo.put("ragEnabled", response.isRagEnabled());
        llmInfo.put("agentChain", response.getAgentChain());
        
        conversation.setConversationContext(JSON.toJSONString(llmInfo));
        conversation.setCreatedTime(LocalDateTime.now());
        
        conversationMapper.insert(conversation);
    }
}
```

#### Day 13-14: å¤§æ¨¡å‹åº”ç”¨ç›‘æ§ä¸ä¼˜åŒ–

1. **å¤§æ¨¡å‹è°ƒç”¨ç›‘æ§**

```java
@Component
@Slf4j
public class LLMMetricsCollector {
    
    /**
     * è®°å½•å¤§æ¨¡å‹è°ƒç”¨æŒ‡æ ‡
     */
    public void recordModelCall(String modelId, long responseTime, int tokenCount, boolean success) {
        // è®°å½•å“åº”æ—¶é—´
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("llm.call.duration")
            .tag("model", modelId)
            .tag("success", String.valueOf(success))
            .register(meterRegistry));
        
        // è®°å½•Tokenä½¿ç”¨é‡
        Gauge.builder("llm.tokens.used")
            .tag("model", modelId)
            .register(meterRegistry, tokenCount);
        
        // è®°å½•æˆåŠŸç‡
        Counter.builder("llm.call.count")
            .tag("model", modelId)
            .tag("success", String.valueOf(success))
            .register(meterRegistry)
            .increment();
    }
}
```

2. **å¤§æ¨¡å‹åº”ç”¨ç¼“å­˜ç­–ç•¥**
3. **å¤šæ¨¡å‹è´Ÿè½½å‡è¡¡ä¼˜åŒ–**

### é˜¶æ®µå››ï¼šå¤§æ¨¡å‹åº”ç”¨æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ3-4å¤©ï¼‰

#### Day 15-16: å¤§æ¨¡å‹åº”ç”¨æµ‹è¯•

1. **RAGç³»ç»Ÿæµ‹è¯•**

```java
@SpringBootTest
@TestPropertySource(properties = {
    "spring.ai.openai.api-key=test-key",
    "llm.rag.vector-store.type=memory"  // æµ‹è¯•ç”¨å†…å­˜å‘é‡å­˜å‚¨
})
class RAGServiceTest {
    
    @Autowired
    private RAGService ragService;
    
    @MockBean
    private VectorStore vectorStore;
    
    @Test
    void testRAGGenerate() {
        // æ¨¡æ‹Ÿå‘é‡æ£€ç´¢ç»“æœ
        List<Document> mockDocs = Arrays.asList(
            new Document("éº»å©†è±†è…ï¼šç»å…¸å·èœï¼Œéº»è¾£é²œé¦™", 
                Map.of("dishId", 1L, "cuisine", "å·èœ"))
        );
        
        when(vectorStore.similaritySearch(any(SearchRequest.class)))
            .thenReturn(mockDocs);
        
        // æµ‹è¯•RAGç”Ÿæˆ
        String result = ragService.ragGenerate("æ¨èå·èœ", createMockContext());
        
        assertThat(result).isNotEmpty();
        assertThat(result).contains("éº»å©†è±†è…");
        
        // éªŒè¯å‘é‡æ£€ç´¢è¢«è°ƒç”¨
        verify(vectorStore).similaritySearch(any(SearchRequest.class));
    }
}
```

2. **å¤šAgentåä½œæµ‹è¯•**

```java
@ExtendWith(MockitoExtension.class)
class AgentCoordinatorTest {
    
    @Mock
    private UnderstandingAgent understandingAgent;
    
    @Mock
    private RecommendationAgent recommendationAgent;
    
    @Mock
    private ResponseAgent responseAgent;
    
    @InjectMocks
    private AgentCoordinatorImpl agentCoordinator;
    
    @Test
    void testAgentPipeline() {
        // æ¨¡æ‹ŸAgenté“¾å¼è°ƒç”¨
        when(understandingAgent.process(any(), any()))
            .thenReturn(AgentResponse.success("ç†è§£å®Œæˆ", mockRequirement));
        
        when(recommendationAgent.process(any(), any()))
            .thenReturn(AgentResponse.success("æ¨èå®Œæˆ", mockRecommendation));
        
        when(responseAgent.process(any(), any()))
            .thenReturn(AgentResponse.success("å›å¤å®Œæˆ", mockChatResponse));
        
        // æµ‹è¯•å®Œæ•´æµç¨‹
        ChatResponse result = agentCoordinator.process("2ä¸ªäººåƒå·èœ", createMockContext());
        
        assertThat(result).isNotNull();
        assertThat(result.getRecommendations()).isNotEmpty();
        
        // éªŒè¯Agentè°ƒç”¨é¡ºåº
        InOrder inOrder = inOrder(understandingAgent, recommendationAgent, responseAgent);
        inOrder.verify(understandingAgent).process(any(), any());
        inOrder.verify(recommendationAgent).process(any(), any());
        inOrder.verify(responseAgent).process(any(), any());
    }
}
```

3. **MCPåè®®æµ‹è¯•**

```java
@Test
void testMCPClientFailover() {
    // æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæ¨¡å‹å¤±è´¥ï¼Œç¬¬äºŒä¸ªæˆåŠŸ
    when(httpClient.post(contains("gpt-4")))
        .thenThrow(new RuntimeException("æ¨¡å‹ä¸å¯ç”¨"));
    
    when(httpClient.post(contains("gpt-3.5-turbo")))
        .thenReturn(createSuccessResponse());
    
    MCPRequest request = MCPRequest.builder()
        .content("æµ‹è¯•æ¶ˆæ¯")
        .build();
    
    // æµ‹è¯•æ•…éšœè½¬ç§»
    MCPResponse response = mcpClient.parallelRequest(
        request, 
        Arrays.asList("gpt-4", "gpt-3.5-turbo")
    );
    
    assertThat(response.isSuccess()).isTrue();
    assertThat(response.getModelId()).isEqualTo("gpt-3.5-turbo");
}
```

#### Day 17-18: å¤§æ¨¡å‹åº”ç”¨æ€§èƒ½ä¼˜åŒ–

1. **å¤§æ¨¡å‹è°ƒç”¨ä¼˜åŒ–ç­–ç•¥**

```java
@Service
@Slf4j
public class LLMOptimizationService {
    
    /**
     * æ™ºèƒ½ç¼“å­˜ç­–ç•¥ - ç¼“å­˜ç›¸ä¼¼æŸ¥è¯¢ç»“æœ
     */
    @Cacheable(value = "llm-cache", key = "#prompt.hashCode()")
    public String getCachedResponse(String prompt) {
        return mcpClient.sendRequest(MCPRequest.builder()
            .content(prompt)
            .build()).getContent();
    }
    
    /**
     * æ‰¹é‡å¤„ç†ä¼˜åŒ– - å‡å°‘APIè°ƒç”¨æ¬¡æ•°
     */
    public List<String> batchProcess(List<String> prompts) {
        // å°†å¤šä¸ªpromptåˆå¹¶æˆä¸€ä¸ªæ‰¹é‡è¯·æ±‚
        String batchPrompt = prompts.stream()
            .map(p -> "Query: " + p)
            .collect(Collectors.joining("\n---\n"));
        
        String batchResponse = mcpClient.sendRequest(MCPRequest.builder()
            .content(batchPrompt)
            .build()).getContent();
        
        // è§£ææ‰¹é‡å“åº”
        return parseBatchResponse(batchResponse);
    }
    
    /**
     * å¼‚æ­¥å¤„ç† - æé«˜å“åº”é€Ÿåº¦
     */
    @Async
    public CompletableFuture<String> asyncProcess(String prompt) {
        return CompletableFuture.supplyAsync(() -> {
            return mcpClient.sendRequest(MCPRequest.builder()
                .content(prompt)
                .build()).getContent();
        });
    }
}
```

2. **å‘é‡æ£€ç´¢æ€§èƒ½ä¼˜åŒ–**

```java
@Service
public class VectorSearchOptimization {
    
    /**
     * åˆ†å±‚æ£€ç´¢ç­–ç•¥ - å…ˆç²—ç­›å†ç²¾ç­›
     */
    public List<Document> hierarchicalSearch(String query) {
        // ç¬¬ä¸€å±‚ï¼šå¿«é€Ÿç²—ç­›ï¼ˆä½ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œå¤šç»“æœï¼‰
        List<Document> roughResults = vectorStore.similaritySearch(
            SearchRequest.query(query)
                .withTopK(50)
                .withSimilarityThreshold(0.5)
        );
        
        // ç¬¬äºŒå±‚ï¼šç²¾ç¡®ç­›é€‰ï¼ˆé«˜ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œå°‘ç»“æœï¼‰
        return roughResults.stream()
            .filter(doc -> calculateExactSimilarity(query, doc) > 0.8)
            .limit(5)
            .collect(Collectors.toList());
    }
    
    /**
     * é¢„è®¡ç®—çƒ­é—¨æŸ¥è¯¢
     */
    @Scheduled(fixedRate = 3600000)  // æ¯å°æ—¶æ‰§è¡Œ
    public void precomputePopularQueries() {
        List<String> popularQueries = getPopularQueries();
        
        for (String query : popularQueries) {
            List<Document> results = vectorStore.similaritySearch(
                SearchRequest.query(query).withTopK(10)
            );
            
            // ç¼“å­˜ç»“æœ
            redisTemplate.opsForValue().set(
                "vector-cache:" + query, 
                results, 
                Duration.ofHours(24)
            );
        }
    }
}
```

3. **ç³»ç»Ÿæ•´ä½“æ€§èƒ½ç›‘æ§**

```java
@Component
public class PerformanceMonitor {
    
    @EventListener
    public void onLLMCall(LLMCallEvent event) {
        // è®°å½•å¤§æ¨¡å‹è°ƒç”¨æ€§èƒ½
        metricsCollector.recordModelCall(
            event.getModelId(),
            event.getResponseTime(),
            event.getTokenCount(),
            event.isSuccess()
        );
        
        // æ€§èƒ½å‘Šè­¦
        if (event.getResponseTime() > 5000) {  // 5ç§’
            alertService.sendSlowResponseAlert(event);
        }
    }
    
    @EventListener
    public void onRAGSearch(RAGSearchEvent event) {
        // è®°å½•RAGæ£€ç´¢æ€§èƒ½
        metricsCollector.recordRAGSearch(
            event.getQuery(),
            event.getSearchTime(),
            event.getResultCount()
        );
    }
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 1. åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•åœºæ™¯1ï¼šåŸºç¡€æ¨èåŠŸèƒ½

```
è¾“å…¥ï¼š"æˆ‘æƒ³è¦2ä¸ªäººåƒè¾£ä¸€ç‚¹çš„å·èœ"
æœŸæœ›è¾“å‡ºï¼š
- æ­£ç¡®è¯†åˆ«äººæ•°ï¼š2
- æ­£ç¡®è¯†åˆ«å£å‘³ï¼šè¾£
- æ­£ç¡®è¯†åˆ«èœç³»ï¼šå·èœ
- æ¨è3-4é“å·èœ
- æ€»ä»·æ ¼åˆç†
```

#### æµ‹è¯•åœºæ™¯2ï¼šå¤šè½®å¯¹è¯

```
ç¬¬ä¸€è½®ï¼š"æˆ‘æƒ³åƒå·èœ"
AIï¼š"å¥½çš„ï¼Œè¯·é—®å‡ ä½ç”¨é¤ï¼Ÿå¯¹è¾£åº¦æœ‰ä»€ä¹ˆè¦æ±‚å—ï¼Ÿ"

ç¬¬äºŒè½®ï¼š"2ä¸ªäººï¼Œè¦è¾£ä¸€ç‚¹çš„"
AIï¼š"ä¸ºæ‚¨æ¨èéº»å©†è±†è…ã€å®«ä¿é¸¡ä¸ã€æ°´ç…®é±¼ç‰‡..."

ç¬¬ä¸‰è½®ï¼š"å¤ªè´µäº†ï¼Œä¾¿å®œä¸€ç‚¹çš„"
AIï¼š"ç†è§£æ‚¨çš„é¢„ç®—è€ƒè™‘ï¼Œæ¨èå›é”…è‚‰ã€éº»è¾£è±†è…..."
```

#### æµ‹è¯•åœºæ™¯3ï¼šå¼‚å¸¸å¤„ç†

```
è¾“å…¥ï¼š"ä»Šå¤©å¤©æ°”çœŸå¥½"
æœŸæœ›ï¼šAIå¼•å¯¼ç”¨æˆ·è¯´æ˜ç”¨é¤éœ€æ±‚

è¾“å…¥ï¼š"dfasldkfj"
æœŸæœ›ï¼šAIæç¤ºæ— æ³•ç†è§£ï¼Œè¯·é‡æ–°æè¿°
```

### 2. æ€§èƒ½æµ‹è¯•æŒ‡æ ‡

| æŒ‡æ ‡       | ç›®æ ‡å€¼  | æµ‹è¯•æ–¹æ³•         |
| ---------- | ------- | ---------------- |
| å“åº”æ—¶é—´   | < 3ç§’   | æ¥å£å‹åŠ›æµ‹è¯•     |
| å¹¶å‘å¤„ç†   | 100 TPS | JMeterå‹æµ‹       |
| æ¨èå‡†ç¡®ç‡ | > 80%   | äººå·¥è¯„ä¼°         |
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.9%   | 24å°æ—¶ç¨³å®šæ€§æµ‹è¯• |

### 3. é›†æˆæµ‹è¯•

1. **ä¸ç°æœ‰è®¢å•ç³»ç»Ÿé›†æˆ**
2. **ç”¨æˆ·ç™»å½•çŠ¶æ€é›†æˆ**
3. **æ”¯ä»˜æµç¨‹é›†æˆ**
4. **æ•°æ®ä¸€è‡´æ€§éªŒè¯**

---

## ğŸš€ éƒ¨ç½²é…ç½®æŒ‡å—

### 1. ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¤§æ¨¡å‹APIé…ç½®
export OPENAI_API_KEY="your_openai_api_key"
export DASHSCOPE_API_KEY="your_dashscope_api_key"

# æ•°æ®åº“é…ç½®
export MYSQL_URL="jdbc:mysql://localhost:3306/star_food_chain"
export MYSQL_USERNAME="root"
export MYSQL_PASSWORD="password"

# Redisé…ç½®
export REDIS_HOST="localhost"
export REDIS_PORT="6379"
export REDIS_PASSWORD=""
```

### 2. Dockeré…ç½®ï¼ˆå¯é€‰ï¼‰

```dockerfile
FROM openjdk:17-jre-slim

COPY target/star-server-1.0.jar app.jar

EXPOSE 8080

ENV SPRING_PROFILES_ACTIVE=prod

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### 3. æ•°æ®åˆå§‹åŒ–è„šæœ¬

```sql
-- åˆå§‹åŒ–èœå“æ ‡ç­¾æ•°æ®
INSERT INTO dish_tags (dish_id, tag_name, tag_type, weight) VALUES
(1, 'è¾£', 'taste', 1.0),
(1, 'å·èœ', 'cuisine', 1.0),
(1, 'ä¸‹é¥­', 'feature', 0.8),
(2, 'ç”œ', 'taste', 0.9),
(2, 'ç²¤èœ', 'cuisine', 1.0);

-- æ›´æ–°ç°æœ‰èœå“æè¿°
UPDATE dish SET description = 'ç»å…¸å·èœï¼Œè±†è…å«©æ»‘ï¼Œéº»è¾£é²œé¦™ï¼Œæ˜¯å¾ˆå—æ¬¢è¿çš„ä¸‹é¥­èœ' WHERE name = 'éº»å©†è±†è…';
```

### 4. ç›‘æ§é…ç½®

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always

logging:
  level:
    com.star.ai: DEBUG
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/star-ai.log
```

---

## ğŸ“Š ä»£ç å®ç°ç¤ºä¾‹

### 1. æ ¸å¿ƒServiceå®ç°

```java
@Service
@Slf4j
public class ConversationServiceImpl implements ConversationService {
    
    @Autowired
    private AgentCoordinator agentCoordinator;
    
    @Autowired
    private ConversationContextManager contextManager;
    
    @Autowired
    private AiConversationMapper conversationMapper;
    
    @Override
    public ChatResponse processMessage(String sessionId, String message, Long userId) {
        log.info("Processing message for session: {}, message: {}", sessionId, message);
        
        try {
            // 1. è·å–æˆ–åˆ›å»ºå¯¹è¯ä¸Šä¸‹æ–‡
            ConversationContext context = contextManager.getOrCreateContext(sessionId, userId);
            
            // 2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
            saveUserMessage(sessionId, userId, message);
            
            // 3. é€šè¿‡Agentåè°ƒå™¨å¤„ç†æ¶ˆæ¯
            ChatResponse response = agentCoordinator.process(message, context);
            
            // 4. ä¿å­˜AIå›å¤
            saveAiResponse(sessionId, response);
            
            // 5. æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡
            contextManager.updateContext(context);
            
            log.info("Successfully processed message for session: {}", sessionId);
            return response;
            
        } catch (Exception e) {
            log.error("Error processing message for session: " + sessionId, e);
            return createErrorResponse(sessionId, "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£æ‚¨çš„éœ€æ±‚ï¼Œè¯·ç¨åå†è¯•ã€‚");
        }
    }
    
    private void saveUserMessage(String sessionId, Long userId, String message) {
        AiConversation conversation = new AiConversation();
        conversation.setSessionId(sessionId);
        conversation.setUserId(userId);
        conversation.setUserMessage(message);
        conversation.setCreatedTime(LocalDateTime.now());
        
        conversationMapper.insert(conversation);
    }
}
```

### 2. Agentåè°ƒå™¨å®ç°

```java
@Component
@Slf4j
public class AgentCoordinatorImpl implements AgentCoordinator {
    
    @Autowired
    private UnderstandingAgent understandingAgent;
    
    @Autowired
    private RecommendationAgent recommendationAgent;
    
    @Autowired
    private ResponseAgent responseAgent;
    
    @Override
    public ChatResponse process(String userMessage, ConversationContext context) {
        log.debug("Agent coordinator processing message: {}", userMessage);
        
        try {
            // 1. ç†è§£ç”¨æˆ·éœ€æ±‚
            UserRequirement requirement = understandingAgent.extractRequirements(userMessage, context);
            log.debug("Extracted requirement: {}", requirement);
            
            // 2. æ‰§è¡Œæ¨èç®—æ³•
            RecommendationResult recommendationResult = recommendationAgent.recommend(requirement, context);
            log.debug("Recommendation result: {} dishes", recommendationResult.getDishes().size());
            
            // 3. ç”Ÿæˆå‹å¥½å›å¤
            ChatResponse response = responseAgent.generateResponse(recommendationResult, context);
            log.debug("Generated response with {} recommendations", response.getDishCards().size());
            
            // 4. æ›´æ–°å¯¹è¯çŠ¶æ€
            updateConversationState(context, requirement, recommendationResult);
            
            return response;
            
        } catch (Exception e) {
            log.error("Error in agent coordination", e);
            throw new AIServiceException("AIæœåŠ¡å¤„ç†å¼‚å¸¸", e);
        }
    }
    
    private void updateConversationState(ConversationContext context, 
                                       UserRequirement requirement, 
                                       RecommendationResult result) {
        context.setCurrentRequirement(requirement);
        context.setLastActiveTime(LocalDateTime.now());
        
        if (result.getDishes().isEmpty()) {
            context.setState(ConversationState.CLARIFICATION);
        } else {
            context.setState(ConversationState.RECOMMENDATION);
        }
    }
}
```

---

## ğŸ“ˆ é¡¹ç›®éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] ç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚
- [ ] AIèƒ½æ­£ç¡®ç†è§£ç”¨é¤äººæ•°ã€å£å‘³ã€èœç³»ç­‰ä¿¡æ¯
- [ ] ç³»ç»Ÿèƒ½æ¨èåˆé€‚çš„èœå“ç»„åˆ
- [ ] æ”¯æŒå¤šè½®å¯¹è¯å’Œéœ€æ±‚æ¾„æ¸…
- [ ] æ¨èç»“æœåŒ…å«ä»·æ ¼ã€æè¿°ã€ç†ç”±
- [ ] èƒ½å¤Ÿå¤„ç†å¼‚å¸¸è¾“å…¥å’Œè¾¹ç•Œæƒ…å†µ

### æŠ€æœ¯éªŒæ”¶

- [ ] ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åˆ’åˆ†åˆç†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°80%ä»¥ä¸Š
- [ ] æ¥å£å“åº”æ—¶é—´å°äº3ç§’
- [ ] æ”¯æŒå¹¶å‘è®¿é—®ï¼Œæ— æ•°æ®ç«äº‰
- [ ] æ—¥å¿—è®°å½•å®Œæ•´ï¼Œä¾¿äºè°ƒè¯•
- [ ] é…ç½®çµæ´»ï¼Œæ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

### ä¸šåŠ¡éªŒæ”¶

- [ ] æ¨èå‡†ç¡®ç‡è¾¾åˆ°80%ä»¥ä¸Š
- [ ] ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥ç»“æœè‰¯å¥½
- [ ] èƒ½å¤Ÿæœ‰æ•ˆå¼•å¯¼ç”¨æˆ·ä¸‹å•
- [ ] é™ä½å®¢æœäººå·¥æˆæœ¬
- [ ] æå‡ç”¨æˆ·ç‚¹é¤ä½“éªŒ

---

## 